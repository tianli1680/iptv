name: IPTV Channel Processor

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:
  push:
    paths:
      - '.github/workflows/iptv-processor.yml'

permissions:
  contents: write

jobs:
  process-iptv:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests beautifulsoup4
        
    - name: Create Python processing script
      run: |
        cat > process_iptv.py << 'EOF'
        #!/usr/bin/env python3
        import re
        import requests
        import time
        import os
        import urllib.parse
        from datetime import datetime
        
        # æ›´å®Œæ•´çš„ç”¨æˆ·ä»£ç†
        HEADERS = {
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36 Edg/120.0.0.0',
            'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8',
            'Accept-Language': 'zh-CN,zh;q=0.9,en;q=0.8',
            'Accept-Encoding': 'gzip, deflate',
            'Connection': 'keep-alive',
            'Upgrade-Insecure-Requests': '1',
            'Cache-Control': 'max-age=0'
        }
        
        # æ–‡ä»¶æ˜ å°„å…³ç³»
        FILE_MAPPING = {
            'live1.m3u': 'å¤®è§†é¢‘é“',
            'live2.m3u': 'å«è§†é¢‘é“',
            'live3.m3u': 'å¤®è§†å’ªå’•',
            'live4.m3u': 'å«è§†å’ªå’•',
            'live5.m3u': 'å½±è§†é¢‘é“',
            'live6.m3u': 'è™ç‰™å½±è§†',
            'live7.m3u': 'æ¸¸æˆèµ›äº‹',
            'live8.m3u': 'å’ªè§†ç•Œbc',
            'live9.m3u': 'å†°èŒ¶ä½“è‚²',
            'live10.m3u': 'å‡¤å‡°é¢‘é“'
        }
        
        def download_m3u(url, retries=3):
            """ä¸‹è½½M3Uæ–‡ä»¶"""
            for attempt in range(retries):
                try:
                    print(f"æ­£åœ¨ä¸‹è½½: {url[:100]}...")
                    
                    # æ·»åŠ è¶…æ—¶å’Œé‡å®šå‘å¤„ç†
                    session = requests.Session()
                    session.max_redirects = 5
                    
                    response = session.get(url, headers=HEADERS, timeout=60, verify=False, allow_redirects=True)
                    
                    print(f"çŠ¶æ€ç : {response.status_code}")
                    print(f"å“åº”å¤§å°: {len(response.content)} å­—èŠ‚")
                    print(f"Content-Type: {response.headers.get('content-type', 'unknown')}")
                    
                    # æ£€æŸ¥ç¼–ç 
                    if response.encoding is None:
                        response.encoding = 'utf-8'
                    
                    content = response.text
                    
                    # è°ƒè¯•ï¼šæ‰“å°å‰500å­—ç¬¦
                    print("å‰500å­—ç¬¦å†…å®¹:")
                    print(content[:500])
                    
                    if '#EXTM3U' in content or '#EXTINF' in content:
                        print(f"âœ“ æˆåŠŸè·å–M3Uå†…å®¹")
                        return content
                    else:
                        # å°è¯•æŸ¥æ‰¾å¯èƒ½çš„é¢‘é“è¡Œ
                        if 'http://' in content or 'https://' in content or ',CCTV' in content or ',å«è§†' in content:
                            print("âš  å†…å®¹å¯èƒ½åŒ…å«é¢‘é“ä¿¡æ¯ä½†ç¼ºå°‘æ ‡å‡†M3Uå¤´")
                            return content
                        else:
                            print("âœ— å†…å®¹çœ‹èµ·æ¥ä¸æ˜¯æœ‰æ•ˆçš„M3Uæ–‡ä»¶")
                            print(f"å†…å®¹æ ·æœ¬: {content[:200]}")
                            return None
                            
                except requests.exceptions.RequestException as e:
                    print(f"ç½‘ç»œé”™è¯¯ (å°è¯• {attempt+1}/{retries}): {e}")
                except Exception as e:
                    print(f"æœªçŸ¥é”™è¯¯ (å°è¯• {attempt+1}/{retries}): {e}")
                
                if attempt < retries - 1:
                    print(f"ç­‰å¾…2ç§’åé‡è¯•...")
                    time.sleep(2)
            
            return None
        
        def parse_m3u_channels(content):
            """è§£æM3Ué¢‘é“ - æ›´å®½æ¾çš„è§£æ"""
            channels = []
            
            if not content:
                print("å†…å®¹ä¸ºç©ºï¼Œæ— æ³•è§£æ")
                return channels
            
            print(f"å¼€å§‹è§£æå†…å®¹ï¼Œæ€»é•¿åº¦: {len(content)} å­—ç¬¦")
            
            lines = content.split('\n')
            print(f"æ€»è¡Œæ•°: {len(lines)}")
            
            current_channel = {}
            extinf_found = False
            
            for i, line in enumerate(lines):
                line = line.strip()
                
                # è·³è¿‡ç©ºè¡Œ
                if not line:
                    continue
                
                # æ‰“å°å‰å‡ è¡Œç”¨äºè°ƒè¯•
                if i < 10:
                    print(f"ç¬¬{i+1}è¡Œ: {line[:100]}")
                
                # æ£€æµ‹EXTINFè¡Œï¼ˆæ”¯æŒå¤šç§æ ¼å¼ï¼‰
                if line.startswith('#EXTINF'):
                    extinf_found = True
                    current_channel = {
                        'extinf': line,
                        'name': '',
                        'group': '',
                        'url': ''
                    }
                    
                    # æå–é¢‘é“åç§° - æ›´å®½æ¾çš„åŒ¹é…
                    # æ ¼å¼å¯èƒ½æ˜¯: #EXTINF:-1,é¢‘é“åç§°
                    # æˆ–è€…: #EXTINF:-1 tvg-id="xxx" tvg-name="xxx" tvg-logo="xxx" group-title="xxx",é¢‘é“åç§°
                    
                    # æŸ¥æ‰¾æœ€åä¸€ä¸ªé€—å·åçš„å†…å®¹ä½œä¸ºé¢‘é“å
                    last_comma = line.rfind(',')
                    if last_comma > 0:
                        channel_name = line[last_comma + 1:].strip()
                        current_channel['name'] = channel_name
                    
                    # æå–åˆ†ç»„ä¿¡æ¯
                    group_match = re.search(r'group-title="([^"]+)"', line)
                    if group_match:
                        current_channel['group'] = group_match.group(1)
                    else:
                        # å°è¯•å…¶ä»–æ ¼å¼
                        group_match = re.search(r'group-title=([^,\s]+)', line)
                        if group_match:
                            current_channel['group'] = group_match.group(1).replace('"', '')
                
                # æ£€æµ‹URLè¡Œï¼ˆä»¥httpæˆ–httpså¼€å¤´ï¼‰
                elif (line.startswith('http://') or line.startswith('https://') or 
                      line.startswith('rtmp://') or line.startswith('rtsp://')):
                    
                    if current_channel and 'url' not in current_channel:
                        current_channel['url'] = line
                        channels.append(current_channel.copy())
                        current_channel = {}
                        extinf_found = False
                    elif extinf_found and not current_channel:
                        # å¦‚æœæœ‰EXTINFæ ‡è®°ä½†æ²¡æœ‰æ•è·åˆ°å®Œæ•´ä¿¡æ¯ï¼Œåˆ›å»ºä¸€ä¸ªåŸºæœ¬é¢‘é“
                        channels.append({
                            'extinf': '#EXTINF:-1,æœªçŸ¥é¢‘é“',
                            'name': 'æœªçŸ¥é¢‘é“',
                            'group': '',
                            'url': line
                        })
                        extinf_found = False
            
            print(f"è§£æå®Œæˆï¼Œæ‰¾åˆ° {len(channels)} ä¸ªé¢‘é“")
            
            # æ‰“å°å‰5ä¸ªé¢‘é“çš„ä¿¡æ¯ç”¨äºè°ƒè¯•
            for i, channel in enumerate(channels[:5]):
                print(f"é¢‘é“{i+1}: åç§°='{channel.get('name', 'N/A')}', åˆ†ç»„='{channel.get('group', 'N/A')}'")
            
            return channels
        
        def process_source1(channels):
            """å¤„ç†ç¬¬ä¸€ä¸ªæº - æ›´å®½æ¾çš„åŒ¹é…"""
            print("\n=== å¤„ç†ç¬¬ä¸€ä¸ªæº (ottiptv) ===")
            
            results = {
                'live1': [],  # cctvå’ŒMCP
                'live2': [],  # å«è§†å’ŒMCP
                'live3': [],  # CCTV
                'live4': []   # å«è§†
            }
            
            if not channels:
                print("æ²¡æœ‰é¢‘é“å¯å¤„ç†")
                return results
            
            for channel in channels:
                name = channel.get('name', '').upper()  # è½¬æ¢ä¸ºå¤§å†™ä¾¿äºåŒ¹é…
                
                print(f"æ£€æŸ¥é¢‘é“: {name}")
                
                # æ£€æŸ¥æ˜¯å¦åŒ…å«MCP
                has_mcp = 'MCP' in name
                
                # live1: åŒ…å«cctvå’ŒMCP
                if ('CCTV' in name or 'Cctv' in name or 'cctv' in name) and has_mcp:
                    results['live1'].append(channel)
                    print(f"  â†’ åŒ¹é… live1 (cctvå’ŒMCP)")
                
                # live2: åŒ…å«å«è§†å’ŒMCP
                elif ('å«è§†' in name or 'WEISHI' in name or 'weishi' in name) and has_mcp:
                    results['live2'].append(channel)
                    print(f"  â†’ åŒ¹é… live2 (å«è§†å’ŒMCP)")
                
                # live3: åŒ…å«CCTV (ä¸åŒ…å«MCP)
                elif ('CCTV' in name or 'Cctv' in name) and not has_mcp:
                    results['live3'].append(channel)
                    print(f"  â†’ åŒ¹é… live3 (CCTV)")
                
                # live4: åŒ…å«å«è§† (ä¸åŒ…å«MCP)
                elif ('å«è§†' in name or 'WEISHI' in name or 'weishi' in name) and not has_mcp:
                    results['live4'].append(channel)
                    print(f"  â†’ åŒ¹é… live4 (å«è§†)")
            
            # è¾“å‡ºç»Ÿè®¡
            print(f"\nç»Ÿè®¡ç»“æœ:")
            print(f"live1.m3u (å¤®è§†é¢‘é“): {len(results['live1'])} ä¸ªé¢‘é“")
            print(f"live2.m3u (å«è§†é¢‘é“): {len(results['live2'])} ä¸ªé¢‘é“")
            print(f"live3.m3u (å¤®è§†å’ªå’•): {len(results['live3'])} ä¸ªé¢‘é“")
            print(f"live4.m3u (å«è§†å’ªå’•): {len(results['live4'])} ä¸ªé¢‘é“")
            
            return results
        
        def process_source2(channels):
            """å¤„ç†ç¬¬äºŒä¸ªæº"""
            print("\n=== å¤„ç†ç¬¬äºŒä¸ªæº (188766.xyz) ===")
            
            results = {
                'live5': [],   # å…¶ä»–é¢‘é“ -> å½±è§†é¢‘é“
                'live6': [],   # è™ç‰™å½±è§†
                'live7': [],   # æ¸¸æˆèµ›äº‹
                'live8': [],   # å’ªè§†ç•Œbc
                'live9': [],   # å†°èŒ¶ä½“è‚²
                'live10': []   # å‡¤å‡°é¢‘é“
            }
            
            if not channels:
                print("æ²¡æœ‰é¢‘é“å¯å¤„ç†")
                return results
            
            for channel in channels:
                group = channel.get('group', '')
                name = channel.get('name', '')
                
                print(f"æ£€æŸ¥é¢‘é“: {name} (åˆ†ç»„: {group})")
                
                # è½¬æ¢ä¸ºå¤§å†™ä¾¿äºåŒ¹é…
                group_upper = group.upper()
                name_upper = name.upper()
                
                # live7: æ¸¸æˆèµ›äº‹
                if 'æ¸¸æˆ' in group or 'èµ›äº‹' in group or 'GAME' in group_upper:
                    results['live7'].append(channel)
                    print(f"  â†’ åŒ¹é… live7 (æ¸¸æˆèµ›äº‹)")
                
                # live6: è™ç‰™å½±è§†
                elif 'è™ç‰™' in group or 'HUYA' in group_upper:
                    results['live6'].append(channel)
                    print(f"  â†’ åŒ¹é… live6 (è™ç‰™å½±è§†)")
                
                # live8: å’ªè§†ç•Œbc
                elif 'å’ªè§†' in group or 'MISHI' in group_upper:
                    results['live8'].append(channel)
                    print(f"  â†’ åŒ¹é… live8 (å’ªè§†ç•Œbc)")
                
                # live9: å†°èŒ¶ä½“è‚²
                elif 'å†°èŒ¶' in group or 'BINGCHA' in group_upper or 'ä½“è‚²' in group:
                    results['live9'].append(channel)
                    print(f"  â†’ åŒ¹é… live9 (å†°èŒ¶ä½“è‚²)")
                
                # live10: å‡¤å‡°é¢‘é“
                elif ('ç²¤è¯­' in group or 'å‡¤å‡°' in name or 
                      'FENGHUANG' in name_upper or 'PHOENIX' in name_upper):
                    # æ£€æŸ¥æ˜¯å¦æ˜¯ç‰¹å®šçš„å‡¤å‡°é¢‘é“
                    if any(phoenix in name for phoenix in ['å‡¤å‡°ä¸­æ–‡', 'å‡¤å‡°èµ„è®¯', 'å‡¤å‡°é¦™æ¸¯', 
                                                          'FENGHUANGZHONGWEN', 'FENGHUANGZIXUN', 
                                                          'FENGHUANGXIANGGANG']):
                        results['live10'].append(channel)
                        print(f"  â†’ åŒ¹é… live10 (å‡¤å‡°é¢‘é“)")
                
                # live5: å…¶ä»–é¢‘é“
                elif 'å…¶ä»–' in group or 'OTHERS' in group_upper or 'å½±è§†' in group:
                    results['live5'].append(channel)
                    print(f"  â†’ åŒ¹é… live5 (å½±è§†é¢‘é“)")
            
            # è¾“å‡ºç»Ÿè®¡
            print(f"\nç»Ÿè®¡ç»“æœ:")
            print(f"live5.m3u (å½±è§†é¢‘é“): {len(results['live5'])} ä¸ªé¢‘é“")
            print(f"live6.m3u (è™ç‰™å½±è§†): {len(results['live6'])} ä¸ªé¢‘é“")
            print(f"live7.m3u (æ¸¸æˆèµ›äº‹): {len(results['live7'])} ä¸ªé¢‘é“")
            print(f"live8.m3u (å’ªè§†ç•Œbc): {len(results['live8'])} ä¸ªé¢‘é“")
            print(f"live9.m3u (å†°èŒ¶ä½“è‚²): {len(results['live9'])} ä¸ªé¢‘é“")
            print(f"live10.m3u (å‡¤å‡°é¢‘é“): {len(results['live10'])} ä¸ªé¢‘é“")
            
            return results
        
        def save_channel_file(channels, filename, category_name):
            """ä¿å­˜é¢‘é“åˆ°æ–‡ä»¶"""
            print(f"\nä¿å­˜æ–‡ä»¶: {filename} ({category_name})")
            
            content = f'#EXTM3U\n'
            content += f'# {category_name}\n'
            content += f'# æ›´æ–°æ—¶é—´: {datetime.now().strftime("%Y-%m-%d %H:%M:%S")}\n'
            content += f'# é¢‘é“æ•°é‡: {len(channels)}\n\n'
            
            if channels:
                for channel in channels:
                    name = channel.get('name', 'æœªçŸ¥é¢‘é“')
                    extinf = channel.get('extinf', '')
                    url = channel.get('url', '')
                    
                    # å¦‚æœextinfåŒ…å«group-titleï¼Œæ›´æ–°å®ƒ
                    if extinf and 'group-title=' in extinf:
                        new_extinf = re.sub(r'group-title="[^"]+"', f'group-title="{category_name}"', extinf)
                        content += f'{new_extinf}\n'
                    else:
                        # åˆ›å»ºæ–°çš„EXTINFè¡Œ
                        tvg_id = re.search(r'tvg-id="([^"]+)"', extinf) if extinf else None
                        tvg_logo = re.search(r'tvg-logo="([^"]+)"', extinf) if extinf else None
                        
                        tvg_id_str = f' tvg-id="{tvg_id.group(1)}"' if tvg_id else ''
                        tvg_logo_str = f' tvg-logo="{tvg_logo.group(1)}"' if tvg_logo else ''
                        
                        content += f'#EXTINF:-1{tvg_id_str}{tvg_logo_str} group-title="{category_name}",{name}\n'
                    
                    content += f'{url}\n\n'
            else:
                content += f'# æš‚æ— é¢‘é“\n'
            
            with open(filename, 'w', encoding='utf-8') as f:
                f.write(content)
            
            print(f"  âœ“ å·²ä¿å­˜ {len(channels)} ä¸ªé¢‘é“åˆ° {filename}")
        
        def test_download():
            """æµ‹è¯•ä¸‹è½½åŠŸèƒ½"""
            print("\n=== æµ‹è¯•ä¸‹è½½åŠŸèƒ½ ===")
            
            # æµ‹è¯•ç¬¬ä¸€ä¸ªURL
            url1 = "https://live.ottiptv.cc/iptv.m3u?userid=8137863657&sign=2c8d82c9f17f480726d4770be9d0fb33fd0fcb31e1024448c36663605ea6a3f99e5bd467b68c287e3f0c07f85b95a188139aa3f19e227e251dc707bce0ededaab73ceeaddf6195&auth_token=54741b289e946919fc1c34ca88db58a4"
            print(f"æµ‹è¯•URL1: {url1[:80]}...")
            content1 = download_m3u(url1)
            
            if content1:
                print(f"URL1 å†…å®¹é•¿åº¦: {len(content1)}")
                channels1 = parse_m3u_channels(content1)
                print(f"URL1 è§£æé¢‘é“æ•°: {len(channels1)}")
            else:
                print("URL1 ä¸‹è½½å¤±è´¥")
            
            # æµ‹è¯•ç¬¬äºŒä¸ªURL
            url2 = "https://bc.188766.xyz/?url=https://live.188766.xyz&mishitong=true&mima=mianfeibuhuaqian&huikan=1"
            print(f"\næµ‹è¯•URL2: {url2}")
            content2 = download_m3u(url2)
            
            if content2:
                print(f"URL2 å†…å®¹é•¿åº¦: {len(content2)}")
                channels2 = parse_m3u_channels(content2)
                print(f"URL2 è§£æé¢‘é“æ•°: {len(channels2)}")
            else:
                print("URL2 ä¸‹è½½å¤±è´¥")
            
            return content1, content2
        
        def create_combined_iptv():
            """åˆ›å»ºæ•´åˆçš„iptv.m3uæ–‡ä»¶"""
            print("\n=== åˆ›å»ºæ•´åˆæ–‡ä»¶ ===")
            
            file_order = [
                'live1.m3u', 'live2.m3u', 'live3.m3u', 'live4.m3u',
                'live5.m3u', 'live6.m3u', 'live7.m3u', 'live8.m3u',
                'live9.m3u', 'live10.m3u'
            ]
            
            combined_content = '#EXTM3U\n'
            combined_content += f'# æ•´åˆIPTVé¢‘é“åˆ—è¡¨\n'
            combined_content += f'# ç”Ÿæˆæ—¶é—´: {datetime.now().strftime("%Y-%m-%d %H:%M:%S")}\n'
            combined_content += f'# æ¥æº: ottiptv.cc + bc.188766.xyz\n\n'
            
            total_channels = 0
            valid_files = 0
            
            for filename in file_order:
                if os.path.exists(filename):
                    try:
                        with open(filename, 'r', encoding='utf-8') as f:
                            file_content = f.read()
                        
                        # æå–é¢‘é“å†…å®¹ï¼ˆè·³è¿‡M3Uå¤´å’Œæ³¨é‡Šï¼‰
                        lines = file_content.split('\n')
                        channel_lines = []
                        in_channels = False
                        
                        for line in lines:
                            line = line.strip()
                            if not line:
                                continue
                            
                            if line.startswith('#EXTINF:'):
                                in_channels = True
                                channel_lines.append(line)
                            elif line.startswith('http://') or line.startswith('https://') or line.startswith('rtmp://') or line.startswith('rtsp://'):
                                if in_channels:
                                    channel_lines.append(line)
                            elif line.startswith('#EXTM3U') or line.startswith('#'):
                                continue
                            else:
                                in_channels = False
                        
                        if channel_lines:
                            # æ·»åŠ åˆ†ç±»æ ‡é¢˜
                            category_name = FILE_MAPPING.get(filename, filename.replace('.m3u', ''))
                            combined_content += f'# {category_name}\n'
                            
                            # æ·»åŠ é¢‘é“å†…å®¹
                            for line in channel_lines:
                                combined_content += f'{line}\n'
                            
                            combined_content += '\n'
                            
                            # ç»Ÿè®¡
                            channel_count = file_content.count('#EXTINF:')
                            total_channels += channel_count
                            valid_files += 1
                            print(f"  {filename}: {channel_count} ä¸ªé¢‘é“ â†’ æ•´åˆå®Œæˆ")
                    except Exception as e:
                        print(f"  {filename}: è¯»å–é”™è¯¯ - {e}")
                else:
                    print(f"  {filename}: æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè·³è¿‡")
            
            # æ·»åŠ ç»Ÿè®¡ä¿¡æ¯
            combined_content += f'# æ€»è®¡: {total_channels} ä¸ªé¢‘é“\n'
            combined_content += f'# åˆ†ç±»: {valid_files} ä¸ª\n'
            combined_content += f'# æ›´æ–°æ—¶é—´: {datetime.now().strftime("%Y-%m-%d %H:%M:%S")}\n'
            
            # ä¿å­˜æ•´åˆæ–‡ä»¶
            with open('iptv.m3u', 'w', encoding='utf-8') as f:
                f.write(combined_content)
            
            print(f"\nâœ“ iptv.m3u åˆ›å»ºæˆåŠŸ")
            print(f"âœ“ æ€»é¢‘é“æ•°: {total_channels}")
            print(f"âœ“ æœ‰æ•ˆåˆ†ç±»: {valid_files} ä¸ª")
            
            return total_channels
        
        def main():
            print("=" * 60)
            print("IPTVé¢‘é“å¤„ç†å¼€å§‹")
            print("=" * 60)
            
            # é¦–å…ˆæµ‹è¯•ä¸‹è½½
            content1, content2 = test_download()
            
            if not content1 and not content2:
                print("ä¸¤ä¸ªæºéƒ½ä¸‹è½½å¤±è´¥ï¼Œæ— æ³•ç»§ç»­å¤„ç†")
                # åˆ›å»ºç©ºæ–‡ä»¶
                for filename, category in FILE_MAPPING.items():
                    save_channel_file([], filename, category)
                create_combined_iptv()
                return False
            
            # å¤„ç†ç¬¬ä¸€ä¸ªæº
            channels1 = []
            if content1:
                channels1 = parse_m3u_channels(content1)
                print(f"\næº1è§£æåˆ° {len(channels1)} ä¸ªé¢‘é“")
                if channels1:
                    source1_results = process_source1(channels1)
                    
                    # ä¿å­˜æº1çš„æ–‡ä»¶
                    print("\nä¿å­˜æº1æ–‡ä»¶:")
                    save_channel_file(source1_results['live1'], 'live1.m3u', 'å¤®è§†é¢‘é“')
                    save_channel_file(source1_results['live2'], 'live2.m3u', 'å«è§†é¢‘é“')
                    save_channel_file(source1_results['live3'], 'live3.m3u', 'å¤®è§†å’ªå’•')
                    save_channel_file(source1_results['live4'], 'live4.m3u', 'å«è§†å’ªå’•')
                else:
                    print("æº1è§£æé¢‘é“å¤±è´¥ï¼Œåˆ›å»ºç©ºæ–‡ä»¶")
                    for filename, category in [('live1.m3u', 'å¤®è§†é¢‘é“'), ('live2.m3u', 'å«è§†é¢‘é“'), 
                                              ('live3.m3u', 'å¤®è§†å’ªå’•'), ('live4.m3u', 'å«è§†å’ªå’•')]:
                        save_channel_file([], filename, category)
            else:
                print("æº1ä¸‹è½½å¤±è´¥ï¼Œåˆ›å»ºç©ºæ–‡ä»¶")
                for filename, category in [('live1.m3u', 'å¤®è§†é¢‘é“'), ('live2.m3u', 'å«è§†é¢‘é“'), 
                                          ('live3.m3u', 'å¤®è§†å’ªå’•'), ('live4.m3u', 'å«è§†å’ªå’•')]:
                    save_channel_file([], filename, category)
            
            # å¤„ç†ç¬¬äºŒä¸ªæº
            channels2 = []
            if content2:
                channels2 = parse_m3u_channels(content2)
                print(f"\næº2è§£æåˆ° {len(channels2)} ä¸ªé¢‘é“")
                if channels2:
                    source2_results = process_source2(channels2)
                    
                    # ä¿å­˜æº2çš„æ–‡ä»¶
                    print("\nä¿å­˜æº2æ–‡ä»¶:")
                    save_channel_file(source2_results['live5'], 'live5.m3u', 'å½±è§†é¢‘é“')
                    save_channel_file(source2_results['live6'], 'live6.m3u', 'è™ç‰™å½±è§†')
                    save_channel_file(source2_results['live7'], 'live7.m3u', 'æ¸¸æˆèµ›äº‹')
                    save_channel_file(source2_results['live8'], 'live8.m3u', 'å’ªè§†ç•Œbc')
                    save_channel_file(source2_results['live9'], 'live9.m3u', 'å†°èŒ¶ä½“è‚²')
                    save_channel_file(source2_results['live10'], 'live10.m3u', 'å‡¤å‡°é¢‘é“')
                else:
                    print("æº2è§£æé¢‘é“å¤±è´¥ï¼Œåˆ›å»ºç©ºæ–‡ä»¶")
                    for filename, category in [('live5.m3u', 'å½±è§†é¢‘é“'), ('live6.m3u', 'è™ç‰™å½±è§†'),
                                              ('live7.m3u', 'æ¸¸æˆèµ›äº‹'), ('live8.m3u', 'å’ªè§†ç•Œbc'),
                                              ('live9.m3u', 'å†°èŒ¶ä½“è‚²'), ('live10.m3u', 'å‡¤å‡°é¢‘é“')]:
                        save_channel_file([], filename, category)
            else:
                print("æº2ä¸‹è½½å¤±è´¥ï¼Œåˆ›å»ºç©ºæ–‡ä»¶")
                for filename, category in [('live5.m3u', 'å½±è§†é¢‘é“'), ('live6.m3u', 'è™ç‰™å½±è§†'),
                                          ('live7.m3u', 'æ¸¸æˆèµ›äº‹'), ('live8.m3u', 'å’ªè§†ç•Œbc'),
                                          ('live9.m3u', 'å†°èŒ¶ä½“è‚²'), ('live10.m3u', 'å‡¤å‡°é¢‘é“')]:
                    save_channel_file([], filename, category)
            
            # åˆ›å»ºæ•´åˆæ–‡ä»¶
            total_channels = create_combined_iptv()
            
            print("\n" + "=" * 60)
            print("å¤„ç†å®Œæˆï¼")
            print(f"æ€»ç”Ÿæˆæ–‡ä»¶: 11ä¸ª (10ä¸ªåˆ†ç±» + 1ä¸ªæ•´åˆ)")
            print(f"æ€»é¢‘é“æ•°: {total_channels}")
            print("=" * 60)
            
            return True
        
        if __name__ == "__main__":
            # å¿½ç•¥SSLè­¦å‘Š
            import urllib3
            urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)
            
            success = main()
            exit(0 if success else 1)
        EOF
        
    - name: Run processing script
      run: python process_iptv.py
      
    - name: Check output files
      run: |
        echo "=== æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶ ==="
        ls -la *.m3u
        echo ""
        echo "=== å„æ–‡ä»¶é¢‘é“æ•°é‡ ==="
        for file in live*.m3u iptv.m3u; do
          if [ -f "$file" ]; then
            count=$(grep -c "^#EXTINF:" "$file" 2>/dev/null || echo "0")
            echo "$file: $count ä¸ªé¢‘é“"
          fi
        done
        
    - name: Create simple README
      run: |
        # è·å–å½“å‰æ—¶é—´
        CURRENT_TIME=$(date +"%Y-%m-%d %H:%M:%S UTC")
        
        # ç»Ÿè®¡é¢‘é“æ•°é‡
        TOTAL=0
        if [ -f "iptv.m3u" ]; then
          TOTAL=$(grep -c "^#EXTINF:" iptv.m3u 2>/dev/null || echo "0")
        fi
        
        cat > README.md << EOF
        # IPTVé¢‘é“åˆ—è¡¨
        
        ## ä¸»æ’­æ”¾åˆ—è¡¨
        - [iptv.m3u](iptv.m3u) - å®Œæ•´é¢‘é“åˆ—è¡¨ ($TOTAL ä¸ªé¢‘é“)
        
        åœ¨çº¿æ’­æ”¾é“¾æ¥ï¼š
        \`\`\`
        https://raw.githubusercontent.com/${{ github.repository }}/main/iptv.m3u
        \`\`\`
        
        ## åˆ†ç±»æ’­æ”¾åˆ—è¡¨
        | æ–‡ä»¶å | åˆ†ç±»åç§° | é¢‘é“æ•° |
        |--------|----------|--------|
        EOF
        
        # æ·»åŠ è¡¨æ ¼è¡Œ
        declare -A files
        files=(
          ["live1.m3u"]="å¤®è§†é¢‘é“"
          ["live2.m3u"]="å«è§†é¢‘é“"
          ["live3.m3u"]="å¤®è§†å’ªå’•"
          ["live4.m3u"]="å«è§†å’ªå’•"
          ["live5.m3u"]="å½±è§†é¢‘é“"
          ["live6.m3u"]="è™ç‰™å½±è§†"
          ["live7.m3u"]="æ¸¸æˆèµ›äº‹"
          ["live8.m3u"]="å’ªè§†ç•Œbc"
          ["live9.m3u"]="å†°èŒ¶ä½“è‚²"
          ["live10.m3u"]="å‡¤å‡°é¢‘é“"
        )
        
        for file in "${!files[@]}"; do
          if [ -f "$file" ]; then
            count=$(grep -c "^#EXTINF:" "$file" 2>/dev/null || echo "0")
            echo "| [$file]($file) | ${files[$file]} | $count |" >> README.md
          else
            echo "| $file | ${files[$file]} | 0 |" >> README.md
          fi
        done
        
        cat >> README.md << EOF
        
        ## æ›´æ–°ä¿¡æ¯
        - **æœ€åæ›´æ–°**: $CURRENT_TIME
        - **æ›´æ–°é¢‘ç‡**: æ¯å¤©è‡ªåŠ¨æ›´æ–°
        - **å¤„ç†è„šæœ¬**: [process_iptv.py](process_iptv.py)
        
        ## è¯´æ˜
        æ­¤ä»“åº“é€šè¿‡GitHub Actionsè‡ªåŠ¨ä»ä»¥ä¸‹æºæå–å¹¶åˆ†ç±»IPTVé¢‘é“ï¼š
        1. https://live.ottiptv.cc/iptv.m3u
        2. https://bc.188766.xyz/
        
        EOF
        
    - name: Commit and push changes
      run: |
        # é…ç½®Git
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        # æ·»åŠ æ‰€æœ‰ç”Ÿæˆçš„æ–‡ä»¶
        git add process_iptv.py
        git add live*.m3u 2>/dev/null || true
        git add iptv.m3u 2>/dev/null || true
        git add README.md
        
        # æäº¤æ›´æ”¹
        if git diff --cached --quiet; then
          echo "æ²¡æœ‰æ›´æ”¹éœ€è¦æäº¤"
        else
          git commit -m "ğŸ“º æ›´æ–°IPTVé¢‘é“åˆ—è¡¨ - $(date +'%Y-%m-%d %H:%M:%S')"
          git push
          echo "æ›´æ”¹å·²æäº¤å¹¶æ¨é€"
        fi
