name: Process M3U Playlists

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */2 * * *'  # 每2小时运行一次

jobs:
  process-playlists:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # 添加仓库写入权限
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Process and categorize M3U playlists
      run: |
        python << 'EOF'
        import re
        import urllib.request
        import urllib.parse
        import os
        import json
        
        # 定义处理函数
        def download_m3u(url):
            """下载m3u文件的辅助函数"""
            print(f"开始下载: {url}")
            try:
                req = urllib.request.Request(url)
                req.add_header('User-Agent', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36')
                with urllib.request.urlopen(req, timeout=30) as response:
                    content = response.read().decode('utf-8')
                print("下载成功")
                return content
            except Exception as e:
                print(f"下载失败: {e}")
                return None
        
        def parse_m3u(content):
            """解析m3u文件的辅助函数"""
            lines = content.split('\n')
            channels = []
            current_channel = {}
            
            for line in lines:
                line = line.strip()
                if line.startswith('#EXTINF:'):
                    # 解析频道信息
                    current_channel = {'header': line}
                    # 提取group-title
                    group_match = re.search(r'group-title="([^"]*)"', line)
                    if group_match:
                        current_channel['group'] = group_match.group(1)
                    else:
                        current_channel['group'] = ''
                    # 提取频道名称
                    name_match = re.search(r',([^,]*)$', line)
                    if name_match:
                        current_channel['name'] = name_match.group(1)
                    else:
                        current_channel['name'] = ''
                    # 提取tvg-name
                    tvg_name_match = re.search(r'tvg-name="([^"]*)"', line)
                    if tvg_name_match:
                        current_channel['tvg_name'] = tvg_name_match.group(1)
                    else:
                        current_channel['tvg_name'] = ''
                elif line and not line.startswith('#') and current_channel:
                    current_channel['url'] = line
                    channels.append(current_channel.copy())
                    current_channel = {}
            
            return channels
        
        def update_group_title(header, new_group):
            """更新分组名称的辅助函数"""
            # 如果已有group-title，则更新
            if 'group-title=' in header:
                pattern = r'group-title="([^"]*)"'
                new_header = re.sub(pattern, f'group-title="{new_group}"', header)
                return new_header
            else:
                # 如果没有，则添加
                parts = header.split(',', 1)
                if len(parts) == 2:
                    new_header = parts[0] + f' group-title="{new_group}",' + parts[1]
                else:
                    new_header = header + f' group-title="{new_group}"'
                return new_header
        
        def write_m3u_file(filename, channel_list, group_name=None):
            """写入m3u文件，并可选地更新group-title"""
            if channel_list:
                with open(filename, 'w', encoding='utf-8') as f:
                    f.write('#EXTM3U\n')
                    for channel in channel_list:
                        header = channel['header']
                        # 如果指定了group_name，则更新header
                        if group_name:
                            header = update_group_title(header, group_name)
                            channel['header'] = header
                        f.write(header + '\n')
                        f.write(channel['url'] + '\n')
                print(f"已写入: {filename} ({len(channel_list)} 个频道)")
                return True
            else:
                print(f"跳过写入空文件: {filename}")
                return False
        
        def rename_file(old_name, new_name, description):
            """重命名文件并添加说明"""
            if os.path.exists(old_name):
                os.rename(old_name, new_name)
                print(f"已重命名 {old_name} -> {new_name} ({description})")
                return True
            return False
        
        # 处理第一个链接
        print("=== 处理第一个链接 ===")
        url1 = "https://live.ottiptv.cc/iptv.m3u?userid=8137863657&sign=2c8d82c9f17f480726d4770be9d0fb33fd0fcb31e1024448c36663605ea6a3f99e5bd467b68c287e3f0c07f85b95a188139aa3f19e227e251dc707bce0ededaab73ceeaddf6195&auth_token=54741b289e946919fc1c34ca88db58a4"
        
        content1 = download_m3u(url1)
        if not content1:
            print("第一个链接下载失败，跳过处理")
        else:
            channels1 = parse_m3u(content1)
            print(f"解析到 {len(channels1)} 个频道")
            
            # 初始化分类列表
            live1_channels = []  # 频道名称包含cctv和MCP -> live1.m3u -> 央视频道
            live2_channels = []  # 频道名称包含卫视和MCP -> live2.m3u -> 卫视频道
            live3_channels = []  # 频道名称包含CCTV -> live3.m3u -> 央视咪咕
            live4_channels = []  # 频道名称包含卫视 -> live4.m3u -> 卫视咪咕
            
            for channel in channels1:
                name = channel.get('name', '').lower()
                tvg_name = channel.get('tvg_name', '').lower()
                
                # 判断条件
                has_cctv = ('cctv' in name or 'cctv' in tvg_name)
                has_weishi = ('卫视' in name or '卫视' in tvg_name)
                has_mcp = ('mcp' in name or 'mcp' in tvg_name)
                
                # 分类规则
                if has_cctv and has_mcp:
                    live1_channels.append(channel)
                elif has_weishi and has_mcp:
                    live2_channels.append(channel)
                elif has_cctv:
                    live3_channels.append(channel)
                elif has_weishi:
                    live4_channels.append(channel)
            
            print(f"live1 (cctv+mcp): {len(live1_channels)} 个频道")
            print(f"live2 (卫视+mcp): {len(live2_channels)} 个频道")
            print(f"live3 (cctv): {len(live3_channels)} 个频道")
            print(f"live4 (卫视): {len(live4_channels)} 个频道")
            
            # 写入文件并更新group-title
            write_m3u_file('live1.m3u', live1_channels, '央视频道')
            write_m3u_file('live2.m3u', live2_channels, '卫视频道')
            write_m3u_file('live3.m3u', live3_channels, '央视咪咕')
            write_m3u_file('live4.m3u', live4_channels, '卫视咪咕')
        
        # 处理第二个链接
        print("\n=== 处理第二个链接 ===")
        url2 = "https://bc.188766.xyz/?url=https://live.188766.xyz&mishitong=true&mima=mianfeibuhuaqian&huikan=1"
        
        content2 = download_m3u(url2)
        if not content2:
            print("第二个链接下载失败，跳过处理")
        else:
            channels2 = parse_m3u(content2)
            print(f"解析到 {len(channels2)} 个频道")
            
            # 初始化分类列表
            live5_channels = []   # 其他频道 -> live5.m3u -> 影视频道
            live6_channels = []   # 虎牙影视 -> live6.m3u -> 虎牙影视
            live7_channels = []   # 游戏赛事 -> live7.m3u -> 游戏赛事
            live8_channels = []   # 咪视界bc -> live8.m3u -> 咪视界bc
            live9_channels = []   # 冰茶体育 -> live9.m3u -> 冰茶体育
            live10_channels = []  # 粤语频道中的凤凰中文、凤凰资讯、凤凰香港 -> live10.m3u -> 凤凰频道
            
            # 凤凰频道关键词
            phoenix_keywords = ['凤凰中文', '凤凰资讯', '凤凰香港']
            
            for channel in channels2:
                group = channel.get('group', '')
                name = channel.get('name', '')
                
                # 根据分组进行分类
                if group == '游戏赛事':
                    live7_channels.append(channel)
                elif group == '虎牙影视':
                    live6_channels.append(channel)
                elif group == '咪视界bc':
                    live8_channels.append(channel)
                elif group == '冰茶体育':
                    live9_channels.append(channel)
                elif group == '粤语频道':
                    # 只提取凤凰中文、凤凰资讯、凤凰香港
                    if any(keyword in name for keyword in phoenix_keywords):
                        live10_channels.append(channel)
                elif group == '其他频道':
                    live5_channels.append(channel)
            
            print(f"live5 (其他频道): {len(live5_channels)} 个频道")
            print(f"live6 (虎牙影视): {len(live6_channels)} 个频道")
            print(f"live7 (游戏赛事): {len(live7_channels)} 个频道")
            print(f"live8 (咪视界bc): {len(live8_channels)} 个频道")
            print(f"live9 (冰茶体育): {len(live9_channels)} 个频道")
            print(f"live10 (凤凰频道): {len(live10_channels)} 个频道")
            
            # 写入文件并更新group-title
            write_m3u_file('live5.m3u', live5_channels, '影视频道')
            write_m3u_file('live6.m3u', live6_channels, '虎牙影视')
            write_m3u_file('live7.m3u', live7_channels, '游戏赛事')
            write_m3u_file('live8.m3u', live8_channels, '咪视界bc')
            write_m3u_file('live9.m3u', live9_channels, '冰茶体育')
            write_m3u_file('live10.m3u', live10_channels, '凤凰频道')
        
        # 重命名文件
        print("\n=== 重命名文件 ===")
        rename_mapping = {
            'live1.m3u': '央视频道',
            'live2.m3u': '卫视频道',
            'live3.m3u': '央视咪咕',
            'live4.m3u': '卫视咪咕',
            'live5.m3u': '影视频道',
            'live6.m3u': '虎牙影视',
            'live7.m3u': '游戏赛事',
            'live8.m3u': '咪视界bc',
            'live9.m3u': '冰茶体育',
            'live10.m3u': '凤凰频道'
        }
        
        # 创建映射表，方便后续整合
        file_map = {}
        for old_name, new_name in rename_mapping.items():
            if os.path.exists(old_name):
                new_file_name = f"{new_name}.m3u"
                rename_file(old_name, new_file_name, new_name)
                file_map[old_name] = new_file_name
            else:
                print(f"文件不存在，跳过重命名: {old_name}")
        
        # 整合所有文件为iptv.m3u
        print("\n=== 整合所有文件为iptv.m3u ===")
        
        # 按要求的顺序整合
        integration_order = [
            'live1.m3u', 'live2.m3u', 'live3.m3u', 'live4.m3u',
            'live5.m3u', 'live6.m3u', 'live7.m3u', 'live8.m3u',
            'live9.m3u', 'live10.m3u'
        ]
        
        channel_count = 0
        with open('iptv.m3u', 'w', encoding='utf-8') as f:
            f.write('#EXTM3U\n')
            
            for original_name in integration_order:
                # 获取重命名后的文件名
                actual_name = file_map.get(original_name, original_name)
                
                if os.path.exists(actual_name):
                    try:
                        with open(actual_name, 'r', encoding='utf-8') as src:
                            content = src.read()
                            # 跳过每个文件的EXTM3U头
                            lines = content.split('\n')[1:]
                            # 过滤空行
                            non_empty_lines = [line for line in lines if line.strip()]
                            if non_empty_lines:
                                f.write('\n'.join(non_empty_lines) + '\n')
                                # 统计频道数
                                channel_count += len([line for line in non_empty_lines if line.startswith('#EXTINF:')])
                        print(f"已整合: {actual_name}")
                    except Exception as e:
                        print(f"整合 {actual_name} 时出错: {e}")
                else:
                    print(f"文件不存在，跳过整合: {actual_name}")
        
        print(f"整合完成，共整合 {channel_count} 个频道到 iptv.m3u")
        
        # 保存文件列表供后续提交使用
        all_files = list(file_map.values()) + ['iptv.m3u']
        with open('processed_files.txt', 'w', encoding='utf-8') as f:
            for filename in all_files:
                f.write(filename + '\n')
        
        print("\n=== 处理完成 ===")
        EOF
    
    - name: Commit and push processed files
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # 添加所有处理后的文件
        if [ -f "processed_files.txt" ]; then
          while IFS= read -r file; do
            if [ -f "$file" ]; then
              git add "$file"
              echo "已添加: $file"
            fi
          done < processed_files.txt
        else
          # 如果processed_files.txt不存在，添加所有可能的m3u文件
          git add *.m3u 2>/dev/null || true
        fi
        
        # 删除临时文件
        rm -f processed_files.txt 2>/dev/null || true
        
        # 检查是否有文件需要提交
        if git diff --staged --quiet; then
          echo "没有文件需要提交"
        else
          git commit -m "自动更新IPTV播放列表 [skip ci]"
          git push
          echo "已提交并推送更改"
        fi
