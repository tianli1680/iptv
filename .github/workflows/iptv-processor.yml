name: Process IPTV Channels

on:
  schedule:
    # 每天凌晨2点运行
    - cron: '0 2 * * *'
  workflow_dispatch: # 支持手动触发
  push:
    paths:
      - '.github/workflows/iptv-processor.yml'

jobs:
  process-iptv:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests m3u8
        
    - name: Create processing script
      run: |
        cat > process_iptv.py << 'EOF'
        #!/usr/bin/env python3
        import re
        import requests
        from urllib.parse import urlparse, parse_qs, urlencode
        from collections import defaultdict
        import m3u8
        
        def download_m3u(url):
            """下载M3U文件"""
            try:
                headers = {
                    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
                }
                response = requests.get(url, headers=headers, timeout=30)
                response.raise_for_status()
                return response.text
            except Exception as e:
                print(f"下载失败 {url}: {e}")
                return None
        
        def parse_m3u_content(content):
            """解析M3U内容"""
            channels = []
            lines = content.split('\n')
            
            current_channel = {}
            for i, line in enumerate(lines):
                line = line.strip()
                if line.startswith('#EXTINF:'):
                    # 解析频道信息
                    current_channel = {}
                    # 提取名称
                    name_match = re.search(r',(.+?)$', line)
                    if name_match:
                        current_channel['name'] = name_match.group(1).strip()
                    else:
                        # 尝试其他格式
                        parts = line.split(',')
                        if len(parts) > 1:
                            current_channel['name'] = parts[-1].strip()
                    
                    # 提取分组信息
                    group_match = re.search(r'group-title="([^"]+)"', line)
                    if group_match:
                        current_channel['group'] = group_match.group(1)
                    
                    # 提取其他属性
                    tvg_id_match = re.search(r'tvg-id="([^"]+)"', line)
                    if tvg_id_match:
                        current_channel['tvg_id'] = tvg_id_match.group(1)
                        
                    tvg_name_match = re.search(r'tvg-name="([^"]+)"', line)
                    if tvg_name_match:
                        current_channel['tvg_name'] = tvg_name_match.group(1)
                        
                    current_channel['extinf'] = line
                    
                elif line and not line.startswith('#') and current_channel:
                    current_channel['url'] = line
                    channels.append(current_channel.copy())
                    current_channel = {}
            
            return channels
        
        def process_source1(channels):
            """处理第一个源"""
            categories = {
                '央视频道': [],
                '卫视频道': [],
                '央视咪咕': [],
                '卫视咪咕': []
            }
            
            for channel in channels:
                name = channel.get('name', '').lower()
                
                if 'cctv' in name and 'mcp' in name:
                    categories['央视频道'].append(channel)
                elif '卫视' in name and 'mcp' in name:
                    categories['卫视频道'].append(channel)
                elif 'cctv' in name.lower():
                    categories['央视咪咕'].append(channel)
                elif '卫视' in name:
                    categories['卫视咪咕'].append(channel)
            
            return categories
        
        def process_source2(channels):
            """处理第二个源"""
            categories = {
                '游戏赛事': [],
                '虎牙影视': [],
                '咪视界bc': [],
                '冰茶体育': [],
                '凤凰频道': [],
                '影视频道': []
            }
            
            for channel in channels:
                group = channel.get('group', '')
                name = channel.get('name', '')
                
                if group == '游戏赛事':
                    categories['游戏赛事'].append(channel)
                elif group == '虎牙影视':
                    categories['虎牙影视'].append(channel)
                elif group == '咪视界bc':
                    categories['咪视界bc'].append(channel)
                elif group == '冰茶体育':
                    categories['冰茶体育'].append(channel)
                elif group == '粤语频道':
                    # 提取特定的凤凰频道
                    if any(phoenix in name for phoenix in ['凤凰中文', '凤凰资讯', '凤凰香港']):
                        categories['凤凰频道'].append(channel)
                elif group == '其他频道':
                    categories['影视频道'].append(channel)
            
            return categories
        
        def create_m3u_content(categories):
            """根据分类创建M3U内容"""
            content = '#EXTM3U x-tvg-url=""\n\n'
            
            for category_name, channels in categories.items():
                if channels:
                    content += f'# {category_name}\n'
                    for channel in channels:
                        # 修改分组名称
                        modified_extinf = re.sub(
                            r'group-title="[^"]+"',
                            f'group-title="{category_name}"',
                            channel['extinf']
                        )
                        content += f"{modified_extinf}\n"
                        content += f"{channel['url']}\n\n"
            
            return content
        
        def main():
            print("开始处理IPTV频道...")
            
            # 第一个源
            print("处理第一个源...")
            url1 = "https://live.ottiptv.cc/iptv.m3u?userid=8137863657&sign=2c8d82c9f17f480726d4770be9d0fb33fd0fcb31e1024448c36663605ea6a3f99e5bd467b68c287e3f0c07f85b95a188139aa3f19e227e251dc707bce0ededaab73ceeaddf6195&auth_token=54741b289e946919fc1c34ca88db58a4"
            content1 = download_m3u(url1)
            
            if content1:
                channels1 = parse_m3u_content(content1)
                categories1 = process_source1(channels1)
                
                with open('source1_processed.m3u', 'w', encoding='utf-8') as f:
                    f.write(create_m3u_content(categories1))
                print(f"第一个源处理完成，保存到 source1_processed.m3u")
                
                # 输出统计信息
                for cat, chs in categories1.items():
                    print(f"  {cat}: {len(chs)} 个频道")
            else:
                print("第一个源下载失败")
            
            # 第二个源
            print("\n处理第二个源...")
            url2 = "https://bc.188766.xyz/?url=https://live.188766.xyz&mishitong=true&mima=mianfeibuhuaqian&huikan=1"
            content2 = download_m3u(url2)
            
            if content2:
                channels2 = parse_m3u_content(content2)
                categories2 = process_source2(channels2)
                
                with open('source2_processed.m3u', 'w', encoding='utf-8') as f:
                    f.write(create_m3u_content(categories2))
                print(f"第二个源处理完成，保存到 source2_processed.m3u")
                
                # 输出统计信息
                for cat, chs in categories2.items():
                    print(f"  {cat}: {len(chs)} 个频道")
            else:
                print("第二个源下载失败")
            
            # 合并两个源
            print("\n合并所有频道...")
            all_categories = {}
            
            # 读取已处理的文件
            for filename in ['source1_processed.m3u', 'source2_processed.m3u']:
                try:
                    with open(filename, 'r', encoding='utf-8') as f:
                        content = f.read()
                        if content:
                            # 提取各个分类
                            sections = re.split(r'# (.*?)\n', content)
                            for i in range(1, len(sections), 2):
                                cat_name = sections[i]
                                cat_content = sections[i+1] if i+1 < len(sections) else ''
                                
                                if cat_name not in all_categories:
                                    all_categories[cat_name] = []
                                
                                # 解析该分类下的频道
                                cat_channels = parse_m3u_content(cat_content)
                                all_categories[cat_name].extend(cat_channels)
                except FileNotFoundError:
                    print(f"文件 {filename} 不存在，跳过")
            
            # 创建合并的M3U
            if all_categories:
                merged_content = create_m3u_content(all_categories)
                with open('merged_iptv.m3u', 'w', encoding='utf-8') as f:
                    f.write(merged_content)
                
                print(f"\n合并完成！总共 {len(all_categories)} 个分类")
                total_channels = sum(len(chs) for chs in all_categories.values())
                print(f"总频道数: {total_channels}")
                
                # 输出详细统计
                for cat, chs in sorted(all_categories.items()):
                    print(f"  {cat}: {len(chs)} 个频道")
            
            print("\n处理完成！")
        
        if __name__ == "__main__":
            main()
        EOF
        
    - name: Run processing script
      run: python process_iptv.py
      
    - name: Create README with statistics
      run: |
        cat > README.md << 'EOF'
        # IPTV 频道处理
        
        此仓库通过 GitHub Actions 自动处理两个 IPTV 源，提取指定频道并分类。
        
        ## 生成的播放列表
        
        1. **source1_processed.m3u** - 处理第一个源的频道
        2. **source2_processed.m3u** - 处理第二个源的频道  
        3. **merged_iptv.m3u** - 合并所有频道的完整列表
        
        ## 频道分类规则
        
        ### 第一个源 (ottiptv.cc)
        - **央视频道**: 包含 "cctv" 和 "MCP" 的频道
        - **卫视频道**: 包含 "卫视" 和 "MCP" 的频道
        - **央视咪咕**: 包含 "CCTV" 的频道
        - **卫视咪咕**: 包含 "卫视" 的频道
        
        ### 第二个源 (188766.xyz)
        - **游戏赛事**: 分组为 "游戏赛事"
        - **虎牙影视**: 分组为 "虎牙影视"
        - **咪视界bc**: 分组为 "咪视界bc"
        - **冰茶体育**: 分组为 "冰茶体育"
        - **凤凰频道**: 分组为 "粤语频道" 中的凤凰中文、凤凰资讯、凤凰香港
        - **影视频道**: 分组为 "其他频道"
        
        ## 自动更新
        
        此播放列表每天自动更新（UTC时间2:00）。您也可以手动触发更新。
        
        ## 使用方法
        
        1. 下载 `merged_iptv.m3u` 文件
        2. 在支持 M3U 播放列表的播放器中打开
        3. 或使用以下链接直接播放：
           ```
           https://raw.githubusercontent.com/YOUR_USERNAME/YOUR_REPO/main/merged_iptv.m3u
           ```
        
        **注意**: 请将 YOUR_USERNAME 和 YOUR_REPO 替换为实际的用户名和仓库名。
        
        ## 最后更新
        $(date)
        
        EOF
        
    - name: Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # 添加生成的文件
        git add process_iptv.py
        git add *.m3u
        git add README.md
        
        # 检查是否有变化
        if git diff --cached --quiet; then
          echo "没有变化需要提交"
        else
          git commit -m "更新IPTV播放列表 - $(date)"
          git push
        fi
